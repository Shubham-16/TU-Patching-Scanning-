---
 - block:
      - name: get all assests
        uri:
          url: https://{{ insightvm_host }}/api/3/assets/search
          user: "{{ insightvm_user }}"
          password: "{{ insightvm_password }}"
          validate_certs: no
          method: POST
          body_format: json
          body: '{
            "filters": [
              {
               "field": "ip-address",
               "operator": "is",
               "value": "{{item}}"
              }
            ],
            "match": "all"
          }'
          force_basic_auth: yes
          timeout: 2408
        register: assets

      - debug:
         msg: "{{assets}}"

      - name: copy the output to a local file {{date}} {{time}}
        copy:
          content: "{{  assets.json }}"
          dest: "./site-assets.json"
        delegate_to: localhost
    
      - name: Parsing the output {{date}} {{time}}
        shell: python2 generate_report/files/parse-json.py "{{ scan_id }}"
        register: output
      
      - debug:
          msg: "{{ output.stdout_lines }}"
     
      - name: append list
        set_fact:
          vulnerable_ips: "{{ vulnerable_ips + [item] }}"
        loop: "{{ output.stdout_lines }}"
      
      - debug:
         msg: "{{ vulnerable_ips }}"
   rescue:
      - name: Send an email if any task fails {{date}} {{time}}
        include_role:
          name: common/send_email
        vars:
          mail_subject: Failed to get details for asset ipv4 address {{item}}
          mail_body: 'Failed to get vulnerability details for asset {{item}} after scan {{scan_name}}. The issue is:- {{ assets.json.message }}. Please check log file,sent on a seperate email.'
        
          
      - name: Abort this role tasks execution if no details of {{item}} found {{date}} {{time}}
        fail:
          msg: Aborting playbook execution, as no vulnerability details for {{item}} were found. The issue was:- {{ assets.json.message }}
        when:  assets.status != 200
 